# Unit Testing
## 1. Giới thiệu
- **Unit Testing** giúp chúng ta kiểm tra từng phần tử nhỏ nhất của ứng dụng như `class`, `method`, `function`, `module`, để đảm bảo rằng nó hoạt động đúng như mong đợi, mà không cần phải khởi chạy toàn bộ ứng dụng.
- **Unit Testing** thể hiện qua các file test, mỗi file test có đuôi là `.spec.ts` hoặc `.test.ts` sẽ kiểm tra một phần nhỏ của ứng dụng.

## 2. Cài đặt
- Để thực hiện **Unit Testing** trong NestJS, chúng ta sử dụng thư viện `@nestjs/testing` có sẵn của NestJS.
>>src/users/auth.service.spec.ts
```typescript
import { Test } from '@nestjs/testing'; // Import module Test từ thư viện testing của NestJS để tạo unit test
import { AuthService } from './auth.service'; // Import AuthService từ file auth.service.ts để sử dụng trong unit test
import { UsersService } from './users.service'; // Import các class, service mà AuthService cần sử dụng
import { User } from './users.entity'; // Import các class, service mà AuthService cần sử dụng

describe('AuthService', () => {
  let service: AuthService; // Khai báo biến service để sử dụng trong các unit test
  beforeEach(async () => {
    // Tạo 1 bản copy giả của module UsersService
    const fakeUsersService: Partial<UsersService> = {
      // Sử dụng Partial để tạo 1 phần method của UsersService phục vụ cho AuthService
      getUserByEmail: (email: string) => Promise.resolve({} as User), // Tạo 1 method getUserByEmail trả về một user giả
      createUser: (email: string, password: string) =>
        Promise.resolve({} as User), // Tạo 1 method createUser trả về một user giả
    }; // LƯU Ý: CÁC METHOD TRONG OBJECT PHẢI TRẢ VỀ PROMISE, và phải khai báo đúng các METHOD được AUTHSERVICE SỬ DỤNG trong USERSERVICE

    // Tạo module testing với các providers cần thiết
    const module = await Test.createTestingModule({
      providers: [
        AuthService, // Cung cấp AuthService để inject vào module
        {
          provide: UsersService, // Cung cấp UsersService để inject vào AuthService
          useValue: fakeUsersService, // Sử dụng giá trị của fakeUsersService để thay thế UsersService thật
        },
      ],
    }).compile(); // Compile module testing để sử dụng

    service = module.get(AuthService); // Lấy AuthService từ module testing để sử dụng trong unit test gán lai cho biến service
  }); // Trước khi chạy các unit test, chúng ta cần khởi tạo môi trường test

  it('can be created instance of AuthService', async () => {
    expect(service).toBeDefined(); // Kiểm tra xem AuthService đã được tạo thành công chưa
  }); // Tạo 1 unit test kiểm tra xem AuthService đã được tạo thành công chưa
}); // Tạo 1 group test cho AuthService để quản lý các unit test

```

## 3. Chạy Unit Test
- Trước tiên, để chạy unit test, chúng ta cần thêm script vào file `package.json`:
```json
"scripts": {
  "test:watch": "jest --watch --maxWorkers=1",
}
```
- Sau đó chạy lệnh `npm run test:watch` để chạy unit test.
- Để chạy một file cụ thể khi gọi lệnh xong, nhấn `p` rồi nhập tên file test cần chạy.
- Nếu Test Pass, sẽ hiển thị kết quả như sau:
```bash
PASS  src/users/auth.service.spec.ts
  √ can be created instance of AuthService (16 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        3.969 s
Ran all test suites matching /auth.service.spec.ts/i.

Watch Usage: Press w to show more.
```

# Test e2e
## 1. Giới thiệu
- **End-to-End Testing** là một loại kiểm thử phần mềm để đảm bảo rằng ứng dụng hoạt động đúng như mong đợi từ góc độ của người dùng cuối.
- **End-to-End Testing** thường được thực hiện trên môi trường giống với môi trường thực tế nhất có thể.
- **End-to-End Testing** thể hiện qua các file test, mỗi file test có đuôi là `.e2e-spec.ts` sẽ kiểm tra toàn bộ ứng dụng.

## 2. Cài đặt
- Để thực hiện **End-to-End Testing** trong NestJS, chúng ta sử dụng thư viện `@nestjs/testing` có sẵn của NestJS.
>>src/app.e2e-spec.ts
```typescript
import { Test, TestingModule } from '@nestjs/testing'; // Import module Test, TestingModule từ thư viện testing của NestJS để tạo end-to-end test
import { INestApplication } from '@nestjs/common'; // Import INestApplication từ @nestjs/common để sử dụng trong end-to-end test
import request from 'supertest'; // Import request từ thư viện supertest để tạo request trong end-to-end test
import { AppModule } from '../src/app.module'; // Import AppModule từ file app.module.ts để sử dụng trong end-to-end test

describe('AppController (e2e)', () => {
  let app: INestApplication; // Khai báo biến app để sử dụng trong các end-to-end test

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule], // Import AppModule để sử dụng trong end-to-end test
    }).compile(); // Compile module testing để sử dụng

    app = moduleFixture.createNestApplication(); // Tạo 1 instance của ứng dụng NestJS để sử dụng trong end-to-end test
    await app.init(); // Khởi tạo ứng dụng NestJS
  }); // Trước khi chạy các end-to-end test, chúng ta cần khởi tạo môi trường test

  it('/ (GET)', () => {
    return request(app.getHttpServer()) // Tạo 1 request GET đến server
      .get('/') // Gửi request GET đến route '/'
      .expect(200) // Mong đợi server trả về status code 200
      .expect('Hello World!'); // Mong đợi server trả về body là 'Hello World!'
  }); // Tạo 1 end-to-end test kiểm tra route '/' trả về 'Hello World!'

  afterEach(async () => {
    await app.close(); // Đóng ứng dụng NestJS sau khi chạy xong các end-to-end test
  }); // Sau khi chạy các end-to-end test, chúng ta cần đóng môi trường test
}); // Tạo 1 group test cho AppController để quản lý các end-to-end test
```

## 3. Chạy End-to-End Test
- Trước tiên, để chạy end-to-end test, chúng ta cần thêm script vào file `package.json`:
```json
"scripts": {
  "test:e2e": "jest --config ./test/jest-e2e.json",
}
```
- Sau đó chạy lệnh `npm run test:e2e` để chạy end-to-end test.
- Nếu Test Pass, sẽ hiển thị kết quả như sau:
```bash
PASS  src/app.e2e-spec.ts
  AppController (e2e)
    √ / (GET) (33 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        3.969 s
Ran all test suites matching /app.e2e-spec.ts/i.

Watch Usage: Press w to show more.
```